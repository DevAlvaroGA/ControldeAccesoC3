@page "/"

@code {

	private bool tornoConectado = true;
	private bool sidebarCollapsed = false;
	private string searchText = "";

	private int contador = 1;
	private string? ultimaHoraEntrada;

	private bool mostrarConfirmacion = false;
	private Alumno? alumnoAEliminar;


	private HashSet<string> filasExpandidas = new();

	private List<Alumno> alumnos = new();

	private List<(string Nombre, string Curso, string Foto)> bancoAlumnos = new()
	{
		("Alejandro García","2º ESO - Grupo B","men/12"),
		("María Rodríguez","4º ESO - Grupo A","women/32"),
		("Javier López","1º Bach - Ciencias","men/45"),
		("Lucía Martínez","2º Bach - Letras","women/44"),
		("Carlos Sánchez","3º ESO - Grupo C","men/67"),
		("Adrián Molina","1º ESO - Grupo A","men/34")
	};

	IEnumerable<Alumno> alumnosFiltrados =>
		alumnos.Where(a =>
			a.Nombre.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
			a.Nre.Contains(searchText));

	void SimularEntrada()
	{
		var random = new Random();
		var baseAlumno = bancoAlumnos[random.Next(bancoAlumnos.Count)];

		var nuevoAlumno = new Alumno(
			baseAlumno.Nombre,
			baseAlumno.Curso,
			(100000 + contador).ToString(),
			baseAlumno.Foto
		);

		contador++;
		alumnos.Insert(0, nuevoAlumno);

		ultimaHoraEntrada = DateTime.Now.ToString("HH:mm:ss");

		ExpandirFila(nuevoAlumno.Nre);
	}

	void ToggleFila(string nre)
	{
		if (filasExpandidas.Contains(nre))
			filasExpandidas.Remove(nre);
		else
			filasExpandidas.Add(nre);
	}

	void ExpandirFila(string nre)
	{
		filasExpandidas.Add(nre);

		_ = Task.Run(async () =>
		{
			await Task.Delay(2500);
			filasExpandidas.Remove(nre);
			await InvokeAsync(StateHasChanged);
		});
	}

	void SacarAlumno(Alumno alumno)
	{
		alumnoAEliminar = alumno;
		mostrarConfirmacion = true;
	}

	void ConfirmarSalida()
	{
		if (alumnoAEliminar is not null)
		{
			alumnos.Remove(alumnoAEliminar);
			filasExpandidas.Remove(alumnoAEliminar.Nre);
			alumnoAEliminar = null;
		}

		mostrarConfirmacion = false;
	}

	void CancelarSalida()
	{
		mostrarConfirmacion = false;
		alumnoAEliminar = null;
	}

	public record Alumno(string Nombre, string Curso, string Nre, string Foto);
}

<div class="layout">

	<!-- SIDEBAR -->
	<div class="sidebar @(sidebarCollapsed ? "collapsed" : "")">

		<div class="logo-section">
			<img src="C3Logo.png" />
		</div>

		<button class="menu-toggle"
				@onclick="() => sidebarCollapsed = !sidebarCollapsed">
			<i class="bi @(sidebarCollapsed ? "bi-chevron-right" : "bi-chevron-left")"></i>
		</button>


		<button class="btn btn-success w-100 mb-3" @onclick="SimularEntrada">
			<i class="bi bi-person-check-fill"></i>
			@if (!sidebarCollapsed)
			{
				<span> Simular entrada</span>
			}
		</button>


	</div>

	<!-- MAIN -->
	<div class="main">

		<!-- HEADER -->
		<div class="header-bar">

			<h3 class="titulo">Control de acceso</h3>

			<!-- ESTADO TORNO A LA DERECHA -->
			<div class="ms-auto d-flex align-items-center gap-3">

				@if (!string.IsNullOrEmpty(ultimaHoraEntrada))
				{
					<div class="text-muted small">
						Última entrada: <strong>@ultimaHoraEntrada</strong>
					</div>
				}

				<div class="torno-mini">
					<div class="led @(tornoConectado ? "" : "off")"></div>
					@(tornoConectado ? "Torno conectado" : "Torno desconectado")
				</div>

				<button class="btn btn-sm btn-outline-secondary"
						@onclick="() => tornoConectado = !tornoConectado">
					<i class="bi bi-arrow-repeat"></i>
				</button>

			</div>

		</div>

		<!-- MÉTRICAS -->
		<div class="metricas">
			<div class="card-metrica">
				<strong>Alumnos dentro</strong>
				<h4>@alumnos.Count</h4>
			</div>
		</div>

		<!-- BUSCADOR -->
		<div class="filtro-bar">
			<input class="form-control"
				   placeholder="Buscar alumno o NRE..."
				   @bind="searchText" />
		</div>

		<!-- LISTA -->
		<div class="lista-card">

			@if (!alumnos.Any())
			{
				<div class="text-center text-muted p-4">
					<i class="bi bi-people fs-3"></i>
					<p class="mt-2">No hay alumnos dentro del aula</p>
				</div>
			}
			else
			{
				@foreach (var alumno in alumnosFiltrados)
				{
					var expandido = filasExpandidas.Contains(alumno.Nre);

					<div class="item @(expandido ? "fila-activa" : "")">

						<img src="@($"https://randomuser.me/api/portraits/{alumno.Foto}.jpg")" />

						<div class="info">
							<strong>@alumno.Nombre</strong>
							<small>@alumno.Curso | NRE: @alumno.Nre</small>
						</div>

						<div class="d-flex gap-2">

							<button class="icon-btn"
									title="Ver"
									@onclick="() => ToggleFila(alumno.Nre)">
								<i class="bi bi-eye-fill"></i>
							</button>

							<button class="icon-btn"
									title="Salida"
									@onclick="() => SacarAlumno(alumno)">
								<i class="bi bi-box-arrow-right"></i>
							</button>

						</div>

					</div>
				}
			}

			@if (mostrarConfirmacion && alumnoAEliminar is not null)
			{
				<div class="overlay">
					<div class="card-grande" style="max-width:500px;">

						<h4>Salida manual</h4>

						<p class="mt-3">
							¿Deseas sacar del aula a:
							<strong>@alumnoAEliminar.Nombre</strong>?
						</p>

						<p class="text-muted">
							NRE: @alumnoAEliminar.Nre <br />
							@alumnoAEliminar.Curso
						</p>

						<div class="d-flex justify-content-center gap-3 mt-4">

							<button class="btn btn-danger"
									@onclick="ConfirmarSalida">
								<i class="bi bi-check-circle"></i> Confirmar salida
							</button>

							<button class="btn btn-outline-secondary"
									@onclick="CancelarSalida">
								Cancelar
							</button>

						</div>

					</div>
				</div>
			}

		</div>

	</div>
</div>
